{"version":3,"sources":["PuzzleBoardProvider.js"],"names":["PuzzleBoardSize","require","Utils","PuzzleBoard","PuzzleBoardStatus","PuzzleBoardProvider","handler","board","undefined","stageDefinition","poemDefinition","puzzleDefinition","console","log","cc","size","translateBoardSize","boardSize","width","x","height","y","appearingCharacters","generateAppearingChars","characterMatrix","generateMatrix","v2","targetCharacters","lines","selectedLines","i","length","j","columnCount","charIndex","isUncoveredChar","characterId","content","push","noiseCharacters","noiseChars","appearingChars","formula","findFormulaDefinition","sourceCharacterA","sourceCharacterB","randomInteger","position","status","IDLE","lastSelectedPosition","ONE_SELECTED","onChooseCharacterAt","areSameVec","areCharactersMatching","onUnchooseCharacterAt","onConnected","posA","posB","charA","getCharacterAt","charB","matchFormulaDefinition","boardType","TINY","SMALL","MEDIUM","LARGE","HUGE"],"mappings":"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","file":"PuzzleBoardProvider.js","sourceRoot":"..\\..\\..\\..\\..\\assets\\Scripts\\Components","sourcesContent":["// Learn cc.Class:\r\n//  - [Chinese] https://docs.cocos.com/creator/manual/zh/scripting/class.html\r\n//  - [English] http://docs.cocos2d-x.org/creator/manual/en/scripting/class.html\r\n// Learn Attribute:\r\n//  - [Chinese] https://docs.cocos.com/creator/manual/zh/scripting/reference/attributes.html\r\n//  - [English] http://docs.cocos2d-x.org/creator/manual/en/scripting/reference/attributes.html\r\n// Learn life-cycle callbacks:\r\n//  - [Chinese] https://docs.cocos.com/creator/manual/zh/scripting/life-cycle-callbacks.html\r\n//  - [English] https://www.cocos2d-x.org/docs/creator/manual/en/scripting/life-cycle-callbacks.html\r\n\r\nvar PuzzleBoardSize = require('Constant').PuzzleBoardSize;\r\n\r\nvar Utils = require('Utils');\r\nrequire('StageDefinition');\r\nrequire('PoemDefinition');\r\nrequire('PuzzleDefinition');\r\n\r\nvar PuzzleBoard = require('PuzzleBoard');\r\nvar PuzzleBoardStatus = PuzzleBoard.PuzzleBoardStatus;\r\n\r\n\r\nclass PuzzleBoardProvider {\r\n    \r\n    constructor(handler) {\r\n        \r\n        this.board = undefined;\r\n        \r\n        this.stageDefinition = undefined;\r\n        this.poemDefinition = undefined;\r\n        this.puzzleDefinition = undefined;\r\n        \r\n        this.handler = handler;\r\n    }\r\n    \r\n    createBoard(stageDefinition) {\r\n        \r\n        if (!stageDefinition) {\r\n            return;\r\n        }\r\n        \r\n        this.stageDefinition = stageDefinition;\r\n        this.poemDefinition = stageDefinition.poemDefinition;\r\n        this.puzzleDefinition = stageDefinition.puzzleDefinition;\r\n        \r\n        console.log('PuzzleBoardProvider: creating PuzzleBoard.');\r\n        this.board = new cc.PuzzleBoard();\r\n        \r\n        var size = this.translateBoardSize(this.puzzleDefinition.boardSize);\r\n        this.board.width = size.x;\r\n        this.board.height = size.y;\r\n        \r\n        var appearingCharacters = this.generateAppearingChars();\r\n        console.log('PuzzleBoardProvider: appearingCharacters:', appearingCharacters);\r\n        \r\n        this.board.characterMatrix = this.generateMatrix(appearingCharacters);\r\n        console.log('PuzzleBoardProvider: matrix:', this.board.characterMatrix);\r\n        \r\n        return this.board;\r\n    }\r\n    \r\n    getBoardSize() {\r\n        \r\n        return cc.v2(this.board.width, this.board.height);\r\n    }\r\n    \r\n    generateAppearingChars() {\r\n        \r\n        var targetCharacters = [];\r\n        \r\n        let lines = this.puzzleDefinition.selectedLines;\r\n        for (var i = 0; i < lines.length; ++i) {\r\n            for (var j = 0; j < this.poemDefinition.columnCount; ++j) {\r\n                \r\n                var charIndex = i * this.poemDefinition.columnCount + j;\r\n                if (this.puzzleDefinition.isUncoveredChar(charIndex)) {\r\n                    continue;\r\n                }\r\n                \r\n                var characterId = this.poemDefinition.content[lines[i]][j];\r\n                targetCharacters.push(characterId);\r\n            }\r\n        }\r\n        \r\n        var noiseCharacters = this.puzzleDefinition.noiseChars;\r\n        for (var i = 0; i < noiseCharacters.length; ++i) {\r\n            \r\n            targetCharacters.push(noiseCharacters[i]);\r\n        }\r\n        \r\n        console.log('PuzzleBoardProvider: targetCharacters:', targetCharacters);\r\n        \r\n        var appearingChars = [];\r\n        for (var i = 0; i < targetCharacters.length; ++i) {\r\n            \r\n            var characterId = targetCharacters[i];\r\n            var formula = this.stageDefinition.findFormulaDefinition(characterId);\r\n            if (formula) {\r\n                appearingChars.push(formula.sourceCharacterA);\r\n                appearingChars.push(formula.sourceCharacterB);\r\n            }\r\n        }\r\n        \r\n        return appearingChars;\r\n    }\r\n    \r\n    generateMatrix(appearingCharacters) {\r\n    \r\n        //var characterMatrix = new Array(this.board.width);\r\n        var characterMatrix = [];\r\n        for (var i = 0; i <= this.board.width + 1; ++i) {\r\n            \r\n            //characterMatrix[i] = new Array(this.board.height);\r\n            characterMatrix[i] = [];\r\n        }\r\n        \r\n        for (var i = 0; i < appearingCharacters.length; ++i) {\r\n            \r\n            var characterId = appearingCharacters[i];\r\n            \r\n            var x = Utils.randomInteger(this.board.width) + 1;\r\n            var y = Utils.randomInteger(this.board.height) + 1;\r\n            \r\n            characterMatrix[x][y] = characterId;\r\n        }\r\n        \r\n        return characterMatrix;\r\n    }\r\n    \r\n    takeActionAt(position) {\r\n        \r\n        if (this.board.status == PuzzleBoardStatus.IDLE) {\r\n            \r\n            this.board.lastSelectedPosition = position;\r\n            this.board.status = PuzzleBoardStatus.ONE_SELECTED;\r\n            \r\n            this.handler.onChooseCharacterAt(position);\r\n            \r\n        } else {\r\n        \r\n            if (Utils.areSameVec(position, this.board.lastSelectedPosition) || !this.areCharactersMatching(position, this.board.lastSelectedPosition)) {\r\n                \r\n                this.board.status = PuzzleBoardStatus.IDLE;\r\n                this.handler.onUnchooseCharacterAt(position, this.board.lastSelectedPosition);\r\n                return;\r\n            }\r\n        \r\n            this.handler.onConnected(position, this.board.lastSelectedPosition, [cc.v2(0,0)]);\r\n        \r\n            \r\n        }\r\n    }\r\n    \r\n    areCharactersMatching(posA, posB) {\r\n    \r\n        var charA = this.getCharacterAt(posA);\r\n        var charB = this.getCharacterAt(posB);\r\n        \r\n        if (!charA || !charB) {\r\n            return false;\r\n        }\r\n        \r\n        return this.stageDefinition.matchFormulaDefinition(charA, charB);\r\n    }\r\n    \r\n    getCharacterAt(position) {\r\n    \r\n        // console.log('retrieving character at ', x, y);\r\n        \r\n        if (this.board.characterMatrix[position.x]) {\r\n            return this.board.characterMatrix[position.x][position.y];\r\n        } else {\r\n            console.log('getCharacterAt error: matrix exceeded: ', position.x, position.y);\r\n        }\r\n    }\r\n    \r\n    translateBoardSize(boardType) {\r\n    \r\n        switch(boardType) {\r\n            case PuzzleBoardSize.TINY: {\r\n                return cc.v2(5, 6);\r\n                break;\r\n            }\r\n            case PuzzleBoardSize.SMALL: {\r\n                return cc.v2(6, 8);\r\n                break;\r\n            }\r\n            case PuzzleBoardSize.MEDIUM: {\r\n                return cc.v2(8, 10);\r\n                break;\r\n            }\r\n            case PuzzleBoardSize.LARGE: {\r\n                return cc.v2(9, 12);\r\n                break;\r\n            }\r\n            case PuzzleBoardSize.HUGE: {\r\n                return cc.v2(10, 14);\r\n                break;\r\n            }\r\n            default: {\r\n                return cc.v2(6, 8);\r\n                \r\n            }\r\n        }\r\n    }\r\n    \r\n}; \r\n\r\ncc.PuzzleBoardProvider = PuzzleBoardProvider;\r\n"]}