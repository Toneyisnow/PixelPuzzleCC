{"version":3,"sources":["../../../../../../assets/Scripts/UI/Controls/assets/Scripts/UI/Controls/PuzzleBoardRenderer.js"],"names":["require","Utils","cc","Class","extends","Component","properties","boardWidth","boardHeight","poemDefinition","default","type","PoemDefinition","puzzleDefinition","PuzzleDefinition","stageDefinition","StageDefinition","anchorStartPoint","v2","anchorInterval","puzzleBoardPrefab","Prefab","connectLineHorizon","connectLineVertical","boardProvider","PuzzleBoardProvider","boardRootNode","Node","init","console","log","self","createBoard","onLoad","size","getBoardSize","i","x","j","y","characterId","getCharacterAt","GlobalStorage","loadCharacterSpriteFrame","characterSpriteFrame","ii","jj","node","name","charSprite","addComponent","Sprite","spriteFrame","position","convertToPixelPosition","scale","puzzleNode","PuzzleNodeRenderer","callbackNode","callbackComponentName","callbackHandlerName","addChild","start","getNodeAtPosition","nodeName","getChildByName","onBoardClickedAt","event","customEventData","target","takeActionAt","onChooseCharacterAt","runAction","scaleTo","onUnchooseCharacterAt","firstPosition","areSameVec","firstNode","onMatchNotConnected","interval","scale1","scale2","blinkAnimation","sequence","blinkAnimation2","onConnected","connectPoints","targetChar","length","lineNodes","lastPoint","point","lineNode","createLinePrefab","push","playAnimationMergeChars","emit","posA","posB","line","undefined","startX","Min","startY","Max","instantiate","anchorX","anchorY","scaleY","Abs","scaleX","pixelX","pixelY","charNodeA","charNodeB","followUpAction","delayAction","delayTime","finishAction","callFunc","removeFromParent","calbackAction"],"mappings":"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","file":"PuzzleBoardRenderer.js","sourceRoot":"../../../../../../assets/Scripts/UI/Controls","sourcesContent":["// Learn cc.Class:\r\n//  - [Chinese] https://docs.cocos.com/creator/manual/zh/scripting/class.html\r\n//  - [English] http://docs.cocos2d-x.org/creator/manual/en/scripting/class.html\r\n// Learn Attribute:\r\n//  - [Chinese] https://docs.cocos.com/creator/manual/zh/scripting/reference/attributes.html\r\n//  - [English] http://docs.cocos2d-x.org/creator/manual/en/scripting/reference/attributes.html\r\n// Learn life-cycle callbacks:\r\n//  - [Chinese] https://docs.cocos.com/creator/manual/zh/scripting/life-cycle-callbacks.html\r\n//  - [English] https://www.cocos2d-x.org/docs/creator/manual/en/scripting/life-cycle-callbacks.html\r\n\r\nrequire('GlobalStorage');\r\nvar Utils = require('Utils');\r\n\r\nrequire('PoemDefinition');\r\nrequire('StageDefinition');\r\nrequire('PuzzleDefinition');\r\nrequire('PuzzleBoardProvider');\r\n\r\nrequire('PuzzleNodeRenderer');\r\n\r\ncc.Class({\r\n    extends: cc.Component,\r\n\r\n    properties: {\r\n        \r\n        boardWidth: 1,\r\n        \r\n        boardHeight: 1,\r\n        \r\n        poemDefinition: {\r\n            default: null,\r\n            type: cc.PoemDefinition,\r\n        },\r\n        \r\n        puzzleDefinition: {\r\n            default: null,\r\n            type: cc.PuzzleDefinition,\r\n        },\r\n        \r\n        stageDefinition: {\r\n            default: null,\r\n            type: cc.StageDefinition,\r\n        },\r\n        \r\n        anchorStartPoint: {\r\n            default: cc.v2(0, 0),\r\n            type: cc.v2\r\n        },\r\n        \r\n        anchorInterval: 64,\r\n        \r\n        puzzleBoardPrefab: cc.Prefab,\r\n        \r\n        connectLineHorizon: cc.Prefab,\r\n        \r\n        connectLineVertical: cc.Prefab,\r\n        \r\n        \r\n        \r\n        \r\n        boardProvider: {\r\n            default: null,\r\n            type: cc.PuzzleBoardProvider,\r\n        },\r\n        \r\n        boardRootNode: {\r\n            default: null,\r\n            type: cc.Node,\r\n        },\r\n        \r\n        \r\n        // foo: {\r\n        //     // ATTRIBUTES:\r\n        //     default: null,        // The default value will be used only when the component attaching\r\n        //                           // to a node for the first time\r\n        //     type: cc.SpriteFrame, // optional, default is typeof default\r\n        //     serializable: true,   // optional, default is true\r\n        // },\r\n        // bar: {\r\n        //     get () {\r\n        //         return this._bar;\r\n        //     },\r\n        //     set (value) {\r\n        //         this._bar = value;\r\n        //     }\r\n        // },\r\n    },\r\n\r\n    // LIFE-CYCLE CALLBACKS:\r\n\r\n    init: function(stageDefinition) {\r\n    \r\n        console.log('PuzzleBoard init.');\r\n        \r\n        this.stageDefinition = stageDefinition;\r\n        this.poemDefinition = this.stageDefinition.poemDefinition;\r\n        this.puzzleDefinition = this.stageDefinition.puzzleDefinition;\r\n        \r\n        if (!this.poemDefinition || !this.puzzleDefinition) {\r\n        \r\n            console.log('poemDefinition is null.');\r\n            return;\r\n        }\r\n        \r\n        var self = this;\r\n        \r\n        this.boardProvider = new cc.PuzzleBoardProvider(this);\r\n        this.boardProvider.createBoard(this.stageDefinition);\r\n        \r\n    },\r\n\r\n\r\n    onLoad () {\r\n        \r\n        var self = this;\r\n        \r\n        var size = this.boardProvider.getBoardSize();\r\n        for (var i = 1; i <= size.x; ++i) {\r\n            for (var j = 1; j <= size.y; ++j) {\r\n        \r\n                var characterId = this.boardProvider.getCharacterAt(cc.v2(i, j));\r\n                \r\n                if (characterId) {\r\n                    \r\n                    console.log('got character: ', i, j, characterId);\r\n                    cc.GlobalStorage.loadCharacterSpriteFrame(characterId, i, j, function(characterSpriteFrame, ii, jj) {\r\n        \r\n                        var node = new cc.Node();\r\n                        node.name = 'char_' + ii + '_' + jj;\r\n                        \r\n                        let charSprite = node.addComponent(cc.Sprite);\r\n                        charSprite.spriteFrame = characterSpriteFrame;\r\n                        \r\n                        //var posX = self.anchorStartPoint.x + ii * self.anchorInterval;\r\n                        //var posY = self.anchorStartPoint.y - jj * self.anchorInterval;\r\n                        \r\n                        //var posX = -160 + ii * 64;\r\n                        //var posY = 226 - jj * 64;\r\n                        \r\n                        node.position = self.convertToPixelPosition(cc.v2(ii, jj));\r\n                        node.scale = 0.5;\r\n                        // node.tag = cc.v2(ii, jj);\r\n                        // node.on(cc.Node.EventType.TOUCH_END, this.onBoardClickedAt, this);\r\n                        \r\n                        \r\n                        // var clickEventHandler = new cc.Component.EventHandler();\r\n                        // clickEventHandler.target = self.node; //这个 node 节点是你的事件处理代码组件所属的节点，这里就是Button2\r\n                        // clickEventHandler.component = \"PuzzleBoardRenderer\";//这个是脚本文件名\r\n                        // clickEventHandler.handler = \"onBoardClickedAt\"; //回调函名称\r\n                        // clickEventHandler.customEventData = cc.v2(ii, jj); //用户数据\r\n                        // \r\n                        // let button = node.addComponent(cc.Button); //获取cc.Button组件\r\n                        // button.clickEvents.push(clickEventHandler);\r\n                        \r\n                        let puzzleNode = node.addComponent(cc.PuzzleNodeRenderer);\r\n                        puzzleNode.position = cc.v2(ii, jj);\r\n                        puzzleNode.callbackNode = self.node;\r\n                        puzzleNode.callbackComponentName = \"PuzzleBoardRenderer\";\r\n                        puzzleNode.callbackHandlerName = \"onBoardClickedAt\";\r\n                        \r\n                        self.boardRootNode.addChild(node);\r\n                    });\r\n                }\r\n            }\r\n        }\r\n        \r\n    },\r\n    \r\n    start () {\r\n\r\n    },\r\n    \r\n    getNodeAtPosition(position) {\r\n        \r\n        var nodeName = 'char_' + position.x + '_' + position.y;\r\n        return this.boardRootNode.getChildByName(nodeName);\r\n    },\r\n\r\n    onBoardClickedAt: function (event, customEventData) {\r\n        \r\n        console.log('onBoardClickedAt');\r\n        \r\n        var node = event.target;\r\n        if (!node || !customEventData) {\r\n            console.log(\"onBoardClickedAt: empty event data detected.\");\r\n            return;\r\n        }\r\n        \r\n        var position = customEventData;\r\n        \r\n        this.boardProvider.takeActionAt(position);\r\n    },\r\n\r\n    // --------------- Callbacks from Provider ---------------\r\n    onChooseCharacterAt: function (position) {\r\n    \r\n        console.log('onChooseCharacterAt triggered.');\r\n        \r\n        var node = this.getNodeAtPosition(position);\r\n        if (node) {\r\n        \r\n            console.log('Got node on ', position.x, position.y);\r\n            \r\n            // Play animation\r\n            node.runAction(new cc.scaleTo(0.3, 0.6));\r\n        }\r\n        \r\n    },\r\n    \r\n    // The two characters not match, or use click the firstPosition again. Cancel them.\r\n    onUnchooseCharacterAt: function (position, firstPosition) {\r\n    \r\n        console.log('onUnchooseCharacterAt triggered.');\r\n        \r\n        var node = this.getNodeAtPosition(position);\r\n        if (node) {\r\n        \r\n            console.log('Got node on ', position.x, position.y);\r\n            \r\n            // Play animation\r\n            node.runAction(cc.scaleTo(0.2, 0.5));\r\n        }\r\n        \r\n        if (Utils.areSameVec(firstPosition, position)) {\r\n            return;\r\n        }\r\n        \r\n        var firstNode = this.getNodeAtPosition(firstPosition);\r\n        if (firstNode) {\r\n        \r\n            console.log('Got node on ', firstPosition.x, firstPosition.y);\r\n            \r\n            // Play animation\r\n            firstNode.runAction(cc.scaleTo(0.2, 0.5));\r\n        }\r\n    },\r\n    \r\n    // The two characters are matching, but not connected, so cancel them\r\n    onMatchNotConnected: function (position, firstPosition) {\r\n        console.log('onMatchNotConnected triggered.');\r\n    \r\n        var interval = 0.06;\r\n        var scale1 = 0.5;\r\n        var scale2 = 0.6;\r\n        \r\n        var blinkAnimation = cc.sequence(cc.scaleTo(interval, scale1), cc.scaleTo(interval, scale2), cc.scaleTo(interval, scale1), cc.scaleTo(interval, scale2), cc.scaleTo(interval, scale1), cc.scaleTo(interval, scale2), cc.scaleTo(interval, scale1));\r\n        var blinkAnimation2 = cc.sequence(cc.scaleTo(interval, scale1), cc.scaleTo(interval, scale2), cc.scaleTo(interval, scale1), cc.scaleTo(interval, scale2), cc.scaleTo(interval, scale1), cc.scaleTo(interval, scale2), cc.scaleTo(interval, scale1));\r\n        \r\n        var node = this.getNodeAtPosition(position);\r\n        if (node) {\r\n        \r\n            console.log('Got node on ', position.x, position.y);\r\n            \r\n            // Play animation\r\n            node.runAction(blinkAnimation);\r\n        }\r\n        \r\n        if (Utils.areSameVec(firstPosition, position)) {\r\n            return;\r\n        }\r\n        \r\n        var firstNode = this.getNodeAtPosition(firstPosition);\r\n        if (firstNode) {\r\n        \r\n            console.log('Got node on ', firstPosition.x, firstPosition.y);\r\n            \r\n            // Play animation\r\n            firstNode.runAction(blinkAnimation2);\r\n        }\r\n    },\r\n\r\n    // Connect from the firstPosition through connectPoints and to the position\r\n    onConnected: function (position, firstPosition, connectPoints, targetChar) {\r\n        \r\n        console.log('onConnected triggered. points:', connectPoints, ' target character:', targetChar);\r\n        \r\n        var self = this;\r\n        var node = this.getNodeAtPosition(position);\r\n        var firstNode = this.getNodeAtPosition(firstPosition);\r\n        if (!node || !firstNode) {\r\n        \r\n            console.log('onConnected: one of the node is undefined, ignore this.');\r\n            return;\r\n        }\r\n        \r\n        if (!connectPoints || connectPoints.length <= 0) {\r\n            console.log('no connect points returned.');\r\n            return;\r\n        }\r\n    \r\n        // Show the lines connect them\r\n        var lineNodes = [];\r\n        for (var i = 1; i < connectPoints.length; i++) {\r\n            var lastPoint = connectPoints[i - 1];\r\n            var point = connectPoints[i];\r\n            \r\n            var lineNode = this.createLinePrefab(lastPoint, point);\r\n            lineNodes.push(lineNode);\r\n            // this.boardRootNode.addChild(lineNode);\r\n        }\r\n        \r\n        this.playAnimationMergeChars(firstNode, node, lineNodes, function() {\r\n            self.node.emit('receivedCharacter', targetChar);\r\n        });\r\n    },\r\n\r\n    createLinePrefab: function(posA, posB) {\r\n        \r\n        var line = undefined;\r\n        var startX = Utils.Min(posA.x, posB.x);\r\n        var startY = Utils.Max(posA.y, posB.y);\r\n        \r\n        if (posA.x == posB.x) {\r\n        \r\n            line = cc.instantiate(this.connectLineVertical);\r\n            line.position = this.convertToPixelPosition(cc.v2(startX, startY));\r\n            line.anchorX = line.anchorY = 0;\r\n            line.scaleY = Utils.Abs(posA.y, posB.y);\r\n            \r\n        } else if (posA.y == posB.y) {\r\n            \r\n            line = cc.instantiate(this.connectLineHorizon);\r\n            line.position = this.convertToPixelPosition(cc.v2(startX, startY));\r\n            line.anchorX = line.anchorY = 0;\r\n            line.scaleX = Utils.Abs(posA.x, posB.x);\r\n            \r\n        } else {\r\n            return undefined;\r\n        }\r\n        \r\n        \r\n        \r\n        return line;\r\n    },\r\n\r\n    convertToPixelPosition: function(position) {\r\n    \r\n        var pixelX = this.anchorStartPoint.x + position.x * this.anchorInterval;\r\n        var pixelY = this.anchorStartPoint.y - position.y * this.anchorInterval;\r\n        \r\n        return cc.v2(pixelX, pixelY);\r\n    },\r\n    \r\n    playAnimationMergeChars: function(charNodeA, charNodeB, lineNodes, followUpAction) {\r\n        \r\n        var self = this;\r\n        \r\n        // Play animation\r\n        charNodeA.runAction(cc.scaleTo(0.3, 0.8));\r\n        charNodeB.runAction(cc.scaleTo(0.3, 0.8));\r\n           \r\n        for (var i = 0; i < lineNodes.length; i++) {\r\n            this.boardRootNode.addChild(lineNodes[i]);\r\n        }\r\n        \r\n        var delayAction = cc.delayTime(0.7);\r\n        var finishAction = cc.callFunc(function () {\r\n            \r\n            charNodeA.removeFromParent();\r\n            charNodeB.removeFromParent();\r\n            \r\n            for (var i = 0; i < lineNodes.length; i++) {\r\n                lineNodes[i].removeFromParent();\r\n            }\r\n        }, this);\r\n\r\n        var calbackAction = cc.callFunc(followUpAction, this);\r\n\r\n        this.node.runAction(cc.sequence(delayAction, finishAction, calbackAction));\r\n    }\r\n    \r\n\r\n    // update (dt) {},\r\n});\r\n"]}