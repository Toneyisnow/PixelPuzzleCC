{"version":3,"sources":["../../../../../assets/Scripts/Components/assets/Scripts/Components/StageDefinition.js"],"names":["require","StageDefinition","stageId","poemDefinition","undefined","puzzleDefinition","formulaDefinitions","targetCharacters","targetCharacterId","i","length","targetCharacter","characterA","characterB","sourceCharacterA","sourceCharacterB","result","lines","selectedLines","columnCount","j","charIndex","isUncoveredChar","characterId","content","push","splice","callback","caller","console","log","resouceUrl","cc","loader","loadRes","JsonAsset","err","stage","loadFromJsonText","json","jsonObject","PoemDefinition","poem","PuzzleDefinition","puzzle","formula","forEach","itemArr","index","FormulaDefinition","loadFromArray","collectTargetCharacters"],"mappings":"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","file":"StageDefinition.js","sourceRoot":"../../../../../assets/Scripts/Components","sourcesContent":["// Learn cc.Class:\r\n//  - [Chinese] https://docs.cocos.com/creator/manual/zh/scripting/class.html\r\n//  - [English] http://docs.cocos2d-x.org/creator/manual/en/scripting/class.html\r\n// Learn Attribute:\r\n//  - [Chinese] https://docs.cocos.com/creator/manual/zh/scripting/reference/attributes.html\r\n//  - [English] http://docs.cocos2d-x.org/creator/manual/en/scripting/reference/attributes.html\r\n// Learn life-cycle callbacks:\r\n//  - [Chinese] https://docs.cocos.com/creator/manual/zh/scripting/life-cycle-callbacks.html\r\n//  - [English] https://www.cocos2d-x.org/docs/creator/manual/en/scripting/life-cycle-callbacks.html\r\n\r\nrequire('PoemDefinition');\r\nrequire('PuzzleDefinition');\r\nrequire('FormulaDefinition');\r\n\r\n\r\nclass StageDefinition {\r\n\r\n    constructor() {\r\n\r\n        this.stageId = 0;\r\n\r\n        this.poemDefinition = undefined;\r\n\r\n        this.puzzleDefinition = undefined;\r\n\r\n        this.formulaDefinitions = [];\r\n\r\n        this.targetCharacters = [];\r\n    }\r\n\r\n    // Load definition from JSON file\r\n    static loadFromFile(stageId, callback, caller) {\r\n\r\n        console.log('loadFromJson:', 'stages/stage_' + stageId);\r\n\r\n        var resouceUrl = 'stages/stage_' + stageId;\r\n        cc.loader.loadRes(resouceUrl, cc.JsonAsset, function( err, result)\r\n        {\r\n            if (err) {\r\n\r\n                console.log('StageDefinition.loadFromFile Error: ', err);\r\n\r\n            } else {\r\n\r\n                let stage = StageDefinition.loadFromJsonText(result.json);\r\n                stage.stageId = stageId;\r\n\r\n                callback(caller, stage);\r\n            }\r\n\r\n            //Object.assign(target, result.json);\r\n\r\n            //console.log('load result poem: ' + JSON.stringify(target.poem));\r\n            //console.log('load result json poem: ' + JSON.stringify(result.json.poem));\r\n        });\r\n    }\r\n\r\n    static loadFromJsonText(jsonObject) {\r\n\r\n        var stage = new cc.StageDefinition();\r\n        stage.poemDefinition = cc.PoemDefinition.loadFromJsonText(jsonObject.poem);\r\n        stage.puzzleDefinition = cc.PuzzleDefinition.loadFromJsonText(jsonObject.puzzle);\r\n\r\n        if (jsonObject.formula) {\r\n            jsonObject.formula.forEach(function (itemArr, index) {\r\n\r\n                var formula = cc.FormulaDefinition.loadFromArray(itemArr);\r\n                stage.formulaDefinitions.push(formula);\r\n            });\r\n        }\r\n\r\n        stage.targetCharacters = stage.collectTargetCharacters();\r\n        return stage;\r\n    }\r\n\r\n    findFormulaDefinition(targetCharacterId) {\r\n\r\n        for (var i = 0; i < this.formulaDefinitions.length; i++) {\r\n\r\n            if (this.formulaDefinitions[i].targetCharacter == targetCharacterId) {\r\n                return this.formulaDefinitions[i];\r\n            }\r\n        }\r\n\r\n        return undefined;\r\n    }\r\n\r\n    matchFormulaDefinition(characterA, characterB) {\r\n\r\n        for (var i = 0; i < this.formulaDefinitions.length; i++) {\r\n\r\n            if (this.formulaDefinitions[i].sourceCharacterA == characterA && this.formulaDefinitions[i].sourceCharacterB == characterB\r\n            || this.formulaDefinitions[i].sourceCharacterB == characterA && this.formulaDefinitions[i].sourceCharacterA == characterB) {\r\n                return this.formulaDefinitions[i];\r\n            }\r\n        }\r\n\r\n        return undefined;\r\n    }\r\n\r\n    collectTargetCharacters() {\r\n\r\n        var result = [];\r\n        let lines = this.puzzleDefinition.selectedLines;\r\n        let columnCount = this.poemDefinition.columnCount;\r\n\r\n        for (var i = 0; i < lines.length; ++i) {\r\n            for (var j = 0; j < columnCount; ++j) {\r\n\r\n                var charIndex = i * columnCount + j;\r\n                if (!this.puzzleDefinition.isUncoveredChar(charIndex)) {\r\n                    var characterId = this.poemDefinition.content[lines[i]][j];\r\n                    result.push(characterId);\r\n                }\r\n            }\r\n        }\r\n\r\n        return result;\r\n    }\r\n\r\n    eraseTargetCharacter(characterId) {\r\n        for(var i = 0; i < this.targetCharacters.length; i++) {\r\n            if (this.targetCharacters[i] == characterId) {\r\n                //// del this.targetCharacters[i:i]\r\n                this.targetCharacters.splice(i, 1);\r\n                return;\r\n            }\r\n        }\r\n    }\r\n};\r\n\r\n\r\n\r\ncc.StageDefinition = StageDefinition;\r\n"]}